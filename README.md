# Place Foursquare - Location Intelligence Platform

This project provides a robust location intelligence platform, leveraging AI agents and various geospatial APIs (TomTom, Google Places, PredictHQ, BestTime.app, OpenWeatherMap, IPstack) to deliver data-driven insights. This `README.md` outlines the new modular agent architecture and guides backend developers on how to interact with the system.

## New Agent Architecture Overview

The system has been refactored into a modular, multi-agent architecture with a clear separation of concerns, enabling parallel processing for different types of data:

1.  **`OrchestratorAgent` (Coordinator & Summary Provider)**: The main entry point for general queries. It coordinates planning, execution, and summarization to provide a human-readable summary and comprehensive raw data.
2.  **`MapDataAgent` (Dedicated Map Data Provider)**: A specialized agent focused solely on generating GeoJSON map data from geospatial queries. Designed to be called via a separate API for parallel processing.
3.  **`PlannerAgent` (Strategist)**: Responsible for analyzing a user's natural language query and generating a precise, step-by-step plan of tool calls required to gather the necessary data. Used by both `OrchestratorAgent` and `MapDataAgent`.
4.  **`executePlanTool` (Executor)**: A specialized tool that takes a plan generated by the `PlannerAgent` and programmatically executes each specified data-gathering tool. Used by both `OrchestratorAgent` and `MapDataAgent`.
5.  **`SummarizerAgent` (Presenter)**: Responsible for synthesizing all collected raw data and the original query into a concise, human-readable summary. Used by `OrchestratorAgent`.
6.  **`formatMapDataTool` (GeoJSON Formatter)**: A specialized tool that consolidates raw geospatial data into a standardized GeoJSON `FeatureCollection`. Used by `MapDataAgent`.

### Architecture Diagram

```
+-------------------+
|                   |
|   User Query      |
|                   |
+---------+---------+
          |
          | (Query for Summary/General Data)
          v
+-------------------+
|                   |
| OrchestratorAgent |
| (LLM-Driven)      |
|                   |
+---------+---------+
          | Calls planTool
          v
+-------------------+
|                   |
|   PlannerAgent    |
| (Generates Plan)  |
|                   |
+---------+---------+
          | Returns Plan (JSON array of tool calls)
          v
+-------------------+
|                   |
|  executePlanTool  |
| (Executes Plan    |
|  Programmatically)|
+---------+---------+
          | Returns Raw Data (JSON object of results)
          v
+-------------------+
|                   |
|  SummarizerAgent  |
| (Generates Summary)|
|                   |
+---------+---------+
          | Returns Summary (Text)
          v
+-------------------+
|                   |
| OrchestratorAgent |
| (Final Response)  |
|                   |
+---------+---------+
          |
          | (API Response: Summary + Raw Data)
          v
+-------------------+
|                   |
|   API Endpoint 1  |
|   /api/summary    |
+-------------------+


+-------------------+
|                   |
|   User Query      |
|                   |
+---------+---------+
          |
          | (Query for Map Data)
          v
+-------------------+
|                   |
|   MapDataAgent    |
| (LLM-Driven)      |
|                   |
+---------+---------+
          | Calls planTool (map-focused)
          v
+-------------------+
|                   |
|   PlannerAgent    |
| (Generates Plan)  |
|                   |
+---------+---------+
          | Returns Plan (JSON array of map-focused tool calls)
          v
+-------------------+
|                   |
|  executePlanTool  |
| (Executes Plan    |
|  Programmatically)|
+---------+---------+
          | Returns Raw Geospatial Data
          v
+-------------------+
|                   |
| formatMapDataTool |
| (GeoJSON Formatter)|
+---------+---------+
          | Returns GeoJSON FeatureCollection
          v
+-------------------+
|                   |
|   MapDataAgent    |
| (Final Response)  |
|                   |
+---------+---------+
          |
          | (API Response: GeoJSON)
          v
+-------------------+
|                   |
|   API Endpoint 2  |
|   /api/map-data   |
+-------------------+
```

## Detailed Flow

1.  **User Query**: A user sends a natural language query (e.g., "Find coffee shops in London with high foot traffic and show me on a map, also what's the weather like there?") to the appropriate API endpoint.

2.  **Summary/General Data Flow (`/api/summary` endpoint -> `OrchestratorAgent`)**:
    *   **Planning**: The `OrchestratorAgent`'s LLM, guided by its instructions, calls the `planTool` with the user's query.
    *   **Plan Generation**: The `planTool` invokes the `PlannerAgent`. The `PlannerAgent`'s LLM analyzes the query and generates a JSON array representing a sequence of tool calls (e.g., `tomtomFuzzySearchTool`, `getFootTrafficSummaryTool`, `getWeatherTool`). This plan is returned to the `OrchestratorAgent`.
    *   **Execution**: The `OrchestratorAgent`'s LLM then calls the `executePlanTool`, passing it the generated plan.
    *   **Tool Execution**: The `executePlanTool` programmatically iterates through the plan, executes the tools, and collects all results into a single JSON object.
    *   **Summarization**: The `executePlanTool` returns the collected raw data to the `OrchestratorAgent`. The `OrchestratorAgent`'s LLM then calls the `summarizeTool`, passing it the original user query and the raw data.
    *   **Summary Generation**: The `summarizeTool` invokes the `SummarizerAgent`. The `SummarizerAgent`'s LLM synthesizes the raw data into a concise, human-readable summary, which is returned to the `OrchestratorAgent`.
    *   **Final Response**: The `OrchestratorAgent`'s LLM outputs this summary as its primary text response. When called with `structuredOutput`, it provides both the summary and the raw data.

3.  **Map Data Flow (`/api/map-data` endpoint -> `MapDataAgent`)**:
    *   **Planning**: The `MapDataAgent`'s LLM, guided by its instructions, calls the `planTool` with the user's query, specifically focusing on geospatial data.
    *   **Plan Generation**: The `planTool` invokes the `PlannerAgent`. The `PlannerAgent`'s LLM generates a plan containing only geospatial tool calls (e.g., `tomtomFuzzySearchTool`, `getGooglePlaceDetailsTool`). This plan is returned to the `MapDataAgent`.
    *   **Execution**: The `MapDataAgent`'s LLM then calls the `executePlanTool`, passing it the map-focused plan.
    *   **Tool Execution**: The `executePlanTool` executes the geospatial tools and collects all raw geospatial results.
    *   **Map Data Formatting**: The `executePlanTool` returns the raw geospatial data to the `MapDataAgent`. The `MapDataAgent`'s LLM then calls the `formatMapDataTool`, passing it the raw geospatial data.
    *   **GeoJSON Generation**: The `formatMapDataTool` consolidates this data into a GeoJSON `FeatureCollection`.
    *   **Final Response**: The `MapDataAgent`'s LLM outputs this GeoJSON `FeatureCollection` as its primary text response.

## Interacting with the System (For Backend Developers)

The system is designed to be consumed via two distinct conceptual API endpoints, allowing for parallel requests for different data types.

### 1. Getting Summary and General Data (`/api/summary` equivalent)

Call the `OrchestratorAgent` to get a human-readable summary and comprehensive raw data from all executed tools.

**Example Usage (TypeScript):**

```typescript
import { mastra } from './src/mastra'; // Adjust path as necessary
import { z } from 'zod'; // For defining the schema

// Define the expected output schema for the OrchestratorAgent's structured response
const orchestratorResponseSchema = z.object({
  summary: z.string().describe('A human-readable summary of the findings.'),
  data: z.record(z.any()).describe('A JSON object containing all raw data collected from tool executions.'),
});

async function getSummaryAndData(userQuery: string) {
  try {
    const orchestratorAgent = mastra.getAgent('Orchestrator Agent');

    // Call the agent with the structuredOutput option
    const response = await orchestratorAgent.generate(userQuery, {
      structuredOutput: {
        schema: orchestratorResponseSchema,
        // Optionally, specify a model if different from the agent's default
        // model: openai('gpt-4o-mini'), 
      },
      maxSteps: 10, // Increase maxSteps if complex queries require more tool calls
    });

    // Access the structured data
    const { summary, data } = response.object;

    console.log("--- Summary ---");
    console.log(summary);

    console.log("\n--- Raw Data (General) ---");
    console.log(JSON.stringify(data, null, 2));

    // Example: Accessing specific data if you know its structure
    if (data['tomtom-fuzzy-search-1'] && data['tomtom-fuzzy-search-1'].results) {
      console.log("TomTom Search Results:", data['tomtom-fuzzy-search-1'].results);
    }
    if (data['get-weather-1'] && data['get-weather-1'].temperature) {
      console.log("Weather Temperature:", data['get-weather-1'].temperature);
    }
    // Note: Raw geospatial results will be here, but not formatted as GeoJSON.

    return { summary, data };

  } catch (error) {
    console.error("Error querying Orchestrator Agent:", error);
    throw error;
  }
}

// Example usage:
// getSummaryAndData("Find cafes in Paris and tell me the weather there.");
```

### 2. Getting GeoJSON Map Data (`/api/map-data` equivalent)

Call the `MapDataAgent` to get a GeoJSON `FeatureCollection` directly.

**Example Usage (TypeScript):**

```typescript
import { mastra } from './src/mastra'; // Adjust path as necessary
import { z } from 'zod'; // For defining the schema

// Define the expected output schema for the MapDataAgent's structured response
// This will be the GeoJSON FeatureCollection schema
const geoJsonFeatureCollectionSchema = z.object({
  type: z.literal('FeatureCollection'),
  features: z.array(z.object({
    type: z.literal('Feature'),
    geometry: z.object({
      type: z.string(),
      coordinates: z.any(),
    }),
    properties: z.record(z.any()).optional(),
  })),
});

async function getMapData(userQuery: string) {
  try {
    const mapDataAgent = mastra.getAgent('Map Data Agent');

    // Call the agent with the structuredOutput option to get GeoJSON
    const response = await mapDataAgent.generate(userQuery, {
      structuredOutput: {
        schema: geoJsonFeatureCollectionSchema,
        // Optionally, specify a model if different from the agent's default
        // model: openai('gpt-4o-mini'), 
      },
      maxSteps: 10, // Increase maxSteps if complex queries require more tool calls
    });

    // Access the GeoJSON object
    const geoJsonData = response.object;

    console.log("--- GeoJSON Map Data ---");
    console.log(JSON.stringify(geoJsonData, null, 2));

    return geoJsonData;

  } catch (error) {
    console.error("Error querying Map Data Agent:", error);
    throw error;
  }
}

// Example usage:
// getMapData("Show me all coffee shops in London on a map.");
```

## Key Agents and Tools

*   **`OrchestratorAgent`**: (`src/mastra/agents/orchestrator-agent.ts`) - The top-level coordinator for summary and general data.
*   **`MapDataAgent`**: (`src/mastra/agents/map-data-agent.ts`) - Specialized agent for GeoJSON map data.
*   **`PlannerAgent`**: (`src/mastra/agents/planner-agent.ts`) - Generates execution plans.
*   **`SummarizerAgent`**: (`src/mastra/agents/summarizer-agent.ts`) - Generates human-readable summaries.
*   **`planTool`**: (`src/mastra/tools/planner-tool.ts`) - Tool to invoke the `PlannerAgent`.
*   **`executePlanTool`**: (`src/mastra/tools/execute-plan-tool.ts`) - Tool to programmatically execute a plan of other tools.
*   **`summarizeTool`**: (`src/mastra/tools/summarizer-tool.ts`) - Tool to invoke the `SummarizerAgent`.
*   **`formatMapDataTool`**: (`src/mastra/tools/format-map-data-tool.ts`) - Tool to consolidate raw geospatial data into GeoJSON.
*   **Data-Gathering Tools**: (e.g., `tomtom-fuzzy-search-tool.ts`, `events-tool.ts`, `google-place-details-tool.ts`, `get-aggregated-metric-tool.ts`, etc.) - These are the core tools that fetch data from external APIs.

## Setup and Running

1.  **Clone the repository:**
    ```bash
    git clone <repository-url>
    cd place-foursquare
    ```
2.  **Install dependencies:**
    ```bash
    npm install
    # or pnpm install if you use pnpm
    ```
3.  **Environment Variables:** Copy `.env.example` to `.env` and fill in your API keys for TomTom, Google, PredictHQ, BestTime.app, OpenWeatherMap, and IPstack.
    ```bash
    cp .env.example .env
    ```
4.  **Run the application (e.g., development server):**
    ```bash
    npm run dev # Or your project's specific start command
    ```